---
id: about-apm-hitmap-class
title: ヒートマップトランザクションを見る
description: ヒートマップトランザクションメニューを活用してWebアプリケーションサーバ（Web Application Server）の問題を把握し、トラブルに対応する方法を紹介します。
tags:
  - アプリケーション
  - アプリケーションモニタリング
  - ヒートマップ
  - トランザクション
  - ヒートマップトランザクション
  - APM
keywords:
  - アプリケーション
  - アプリケーションモニタリング
  - ヒートマップ
  - トランザクション
  - ヒートマップトランザクション
  - APM
displayed_sidebar: learningSidebar
---

この文書では、[WhaTapモニタリングサービス](https://service.whatap.io)の機能のうち、**_ヒートマップトランザクション_**メニューを活用してウェブアプリケーションサーバ(Web Application 
 Server)の問題を把握し、トラブルに対応する方法を紹介します。 

アプリケーションモニタリング業務担当者は、担当業務分野によってモニタリングしたい要素が異なります。サーバー担当者はCPU、メモリ、ディスク、ネットワークなどのリソースをモニタリングし、リソースをどの程度使用しているかを確認したいと考えています。DB担当者はDBクエリのパフォーマンス向上のための指標を見たいと考えています。 

一方、従来のモニタリング方法では、サービス（AP）担当者は通常、ヒープ使用量とCPU使用量を確認するだけでした。しかし、この方法では、サービス（AP）の問題が何であるかを特定することができません。サービス（AP）で最も重要なのは、ユーザーのリクエストに正しく応答し、どれだけ速く、エラーなく応答するかです。これを把握するために、ユーザーのリクエストが正しく実行されたかどうかを確認するプロセスが必要です。ユーザーのリクエストの1つ1つをリクエストと呼び、このリクエストをサーバーで処理し、ユーザーに応答するプロセスをトランザクション（Transaction）と定義します。 

WhaTapモニタリングサービスでは、トランザクションを「進行中のトランザクション」と「終了したトランザクション」に区分し、サービス（AP）のトラブル状況を把握することができます。**_アプリケーションダッシュボード_**メニューの**_ヒートマップ_**ウィジェットでは、「終了した個別トランザクション」を分布図形式のチャートで確認することができます。ヒートマップチャートは、5秒単位で終了したトランザクション情報を収集し、点単位で表現したウィジェットです。このチャートにより、ユーザーは1秒かかるトランザクションが予想とは異なり、2秒ほどかかる場合、つまり応答時間が2倍以上かかるトランザクションを見つけてトラブル原因を分析できます。

## パターン分析

分布図チャートの形態によってどのようなトラブルが発生したのかを確認する方法について説明します。

**_ヒートマップトランザクション_**は、時間の経過とともにユーザーのリクエストに対する応答時間を分布図形式で表現したチャートです。**_アプリケーションダッシュボード_**でヒートマップウィジェットの右上に! [右方向アイコン](/img/right-arrow.svg)を選択すると、**_ヒートマップトランザクション_**メニューに入ることができます。

![ヒートマップトランザクション](/img/best-p/best-p-hitmap-transaction.png)

横軸はトランザクションの終了時間、縦軸は応答時間です。トランザクションを終了した時間ごとに、ユーザのリクエスト（Request）に対する応答（Response）時間をチャート上に四角形で表現します。これにより、ユーザーのリクエストに正常に応答したかどうかを把握できます。ヒートマップトランザクションチャートの四角いボックスの色は、次のような意味を持っています。

-   <span class='normal'>青色</span>： 正常トランザクション
-   <span class='slow'>주황색</span>, <span class='vslow'>빨간색</span>: 에러가 발생했거나 응답 요청이 거부된 상태이며 에러 빈도에 따라 빨간색에 가까운 색상으로 표현됩니다.

このチャートで最も重要な点は、トランザクションボックスが縦または横に並んでいる状況です。次のヒートマップパターンを参照してください。

<div class='pattern-intro'>

<div class='pattern-img'>

![縦線パターン](https://www.whatap.io/ko/blog/113/img/blog_03.webp)

</div>

<div>

**縦線が一時的に現れるパターン**です。縦列が発生する場合は、各トランザクションの応答時間は異なりますが、終了時間は同じであることを意味します。トランザクション処理中に一時的にロック（Lock）が発生すると、トランザクションの処理を待機します。ロックが解消され、待機中のトランザクションはほぼ同じ時間帯に一度に終了します。このような現象により、縦線が作成されます。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![横線パターン](https://www.whatap.io/ko/blog/113/img/blog_04.webp)

</div>

<div>

**横線が現れるパターン**です。10秒タイムアウト条件でそのリソースが不足すると、多くのトランザクションは10秒待機後にタイムアウトエラーが発生します。この時、ヒートマップの10秒付近に横線が発生します。タイムアウト後に再試行するロジックがある場合は、上図のように横線が10秒単位で繰り返します。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![フライングパターン](https://www.whatap.io/ko/blog/113/img/blog_05.webp)

</div>

<div>

**波打つように見えるフライングパターン**は特定リソースやログのような共通リソース不足現象で間隔をあけて現れるパターンです。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![過負荷パターン](https://www.whatap.io/ko/blog/113/img/blog_06.webp)

</div>

<div>

**過負荷パターン**は、全体または一部の応答に一時的に問題が発生するトランザクションが一度に密集するときに現れるパターンです。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![暴走パターン](https://www.whatap.io/ko/blog/113/img/blog_07.webp)

</div>

<div>

**暴走パターン**は、過度なトランザクションのリクエストや負荷が発生した場合、応答時間が全体的に増加するパターンです。

</div>
</div>

パターンが発生したときにパターンを発生させる要因がサーバーの内部か外部かを把握することが重要です。次の図のような構造でシステムを設計したと仮定します。

![](/img/best-p/hitmap-transaction-sample.png)

チャートの下部領域は、ほとんど応答時間が速いトランザクションであるため、パターンを見つけることはそれほど意味がありません。上部領域の遅い区間で作られたパターンの共通点を探すことが必要です。縦線パターンが発生した時、サービス（AP）でロック（Lock）が発生した場合、1つのウェブアプリケーションでのみパターンが発生します。逆に、外部と接続されたDatabaseでロックが発生すると、すべてのウェブアプリケーションにパターンが発生します。 

チャート領域をドラッグすると、ドラッグした領域のトランザクション情報を画面下部の**_TXトレース_**一覧に読み込むことができます。**_エージェント名_**カラム項目を通じて問題発生のソースを把握することもできます。また、右側の**_アプリケーション_**ウィジェットではエージェントをグループ化して一覧として表示します。

トラブルの原因について共通点を見つけることが目的です。まず、同じアプリケーションで問題が発生の有無を確認してください。第二に、同じURLで問題が発生したかどうかを確認してください。その他、クライアントIPが同じかどうかを調べることもできます。

## 区間およびスタック分析

もしトラブルの原因が外部ではなく内部の問題である場合、どのように確認できるでしょうか？WhaTapは、**アクティブスタック**という技術を使用して、実行中のトランザクションのスタック情報を収集します。スタック情報は10秒ごとに収集され、収集されたデータは統計情報として確認できます。ここには、サービスのロジックを実行する各メソッド、SQL、外部呼び出し情報も含まれます。 

内部の問題なら、各トランザクションの実行履歴を時間ごとに確認し、遅くなった区間を把握すれば、問題を見つけて解決することができます。外部の問題ならSQL、外部呼び出し情報を確認してみてください。

例えば、縦線パターンからロックを発生させる要因を探すには、同じパターン内で最も遅かったトランザクションと最も早かったトランザクションの接点を確認する方法があります。ヒートマップチャートでパターンが発生した領域をドラッグしてください。**_TXトレース_**一覧にドラッグした領域のトランザクション情報を読み込みます。**_TXトレース_**一覧を経過時間基準で並べ替えてから、最も長くかかったトランザクションを選択してください。選択したトランザクションに関する詳細情報が含まれた**_統計_**ウィンドウが表示されます。

![](/img/best-p/hitmap-transaction-sample-02.png)

**_テーブルビュー_**タブで段階別**_区間時間_**と**_所要_**時間を確認することができます。**_区間時間_**は各段階が開始または終了した時間、**_所要_**は各メソッドの開始から終了までの総所要時間です。**_ギャップ_**は、先に実行したメソッド間の間隔です。

**_テーブルビュー_**タブで遅くなった区間を見つけることができます。同じように、最も早かったトランザクションでも遅くなった区間を確認してください。共通点を見つけることができます。遅くなった区間がサービス（AP）のロジックによって発生した状況であれば、**_アクティブスタック_**を確認してください。**_アクティブスタック_**ボタンをクリックすると、詳細情報が含まれたウィンドウが表示されます。該当**_アクティブスタック_**と先に実行されたメソッドとの相関関係を確認するには、その段階の番号を参照してください。この番号を**_ツリービュー_**タブをクリックし、番号を確認します。**_ツリービュー_**タブだけではメソッドが開始した時間を把握することができないため、**_テーブルビュー_**タブを通じて**_区間時間_**を先に確認してください。 

![](/img/best-p/hitmap-transaction-sample-03.png)

:::note

-   **アクティブスタック**は10秒に一度スナップショットを保存しているため、どの区間でも確認できます。応答時間が長くなる区間を確認する確率が高くなるため、**アクティブスタック**を通じて区間が開いたポイントを見つけることができます。
-   **_TXトレース_**一覧で**アクティブスタック**を含むトランザクションは、 <span class='mark active'>A</span>アイコンを表示します。

:::

ヒートマップチャートでトランザクションを見るのは、関連するトランザクションを見つけることが目的です。一緒に参照すべきトランザクションを確認し、応答時間や終了時間に影響を与える要素を特定する必要があります。アプリケーションですべてのメソッドを追跡すると、区間分析が可能ですが、オーバーヘッドを起こして応答時間に歪みを与える可能性があります。そのため、選別されたクラスメソッドのみを追跡する必要があります。その選別要点は運営者の観点からだけ決定しますが、トラブルを起こすロックや他の要素が追跡から除外されることがあります。この除外される部分をサポートするのが**アクティブスタック**です。 

WhaTapのモニタリングサービスは、アプリケーションサーバを運営しながら通常繰り返される問題を見つけるために、繰り返して**アクティブスタック**をスナップショットに記録します。トラブルを引き起こす重要な要因を確率的に高く見つけることができます。このように収集した資料を統計的に確認できるメニューが**_分析_**>**_スタック_**です。スタックの詳細については、[次の文書](https://docs.whatap.io/java/analysis-apm)を参照してください。

:::note

![](/img/best-p/hitmap-transaction-sample-08.png)

-   **_統計_**ウィンドウの右上に**_もっと見る_**ボタンをクリックすると、トランザクションに関する基本情報を広げて確認することができます。エラー情報、クライアントIP、使用機器、OS、国の情報などを提供します。その他、パッチ件数および時間、SQL件数および時間などを確認し、どれだけ多くの呼び出しを使用しているのかも把握できます。
-   上記の情報を要約してグラフで表現したものが画面の真ん中に位置する**_ダイアグラム_**チャートです。詳細については、[次の文書](https://docs.whatap.io/java/trs-profile)を参照してください。

:::

## 呼び出し関係分析

-   **_メソッド要約_**

    **_統計_**ウィンドウの**_メソッド要約_**タブを選択してください。SQLと同様に、メソッドも一つのトランザクション内でどれだけ多く呼び出されたかを確認することができます。 

    ![](/img/best-p/hitmap-transaction-sample-05.png)

    このように確認した情報に基づいて繰り返し実行されるメソッドがあるか、同じメソッドが繰り返し呼び出されるかを確認し、改善点を見つけることができます。

-   **_SQL要約_**

    トラブルを引き起こす要因が内部ロジックではなくSQLである場合を説明します。一つのトランザクション内でSQLの実行を統計的に確認するには、**_統計_**ウィンドウの**_SQL要約_**タブを選択してください。

    ![](/img/best-p/hitmap-transaction-sample-04.png)

    同じSQLをどれだけ繰り返して呼び出すかを確認してください。ロジックから呼び出す回数を減らしたり、他の解決策を見つけてDBの負担を軽減できる方法を見つける必要があります。DataBaseの負担を軽減することは、サーバ運営のために非常に重要です。アプリケーションサーバーはScale-Outができます。これはリソースを継続的に増やすことができます。一方、DataBaseを分割することは、アプリケーションに対して途方もなく多くの再開発を伴います。パフォーマンスチューニングの基本は、できるだけアプリケーションでDataBaseへの負担を軽減する方向で進める必要があります。 

-   **_HTTPリクエスト要約_**

    **_統計_**ウィンドウの**_HTTPリクエスト要約_**タブを選択してください。HTTPリクエストのリクエスト件数、合計時間、平均時間を提供します。

-   **マルチトランザクション**

    モノリティック環境では単一のAPM構成でした。この場合、該当APMのトランザクションのみを確認します。最近では、マイクロサービスアーキテクチャなどの技術トレンドが主流です。単一APMが小さな単位に分かれるため、収集しなければならないトランザクションもそれだけ増えます。このような場合、分けられたトランザクションをすべて収集するには負荷がかかるため、1つのトランザクションに連携したトランザクションを一緒に収集するようにします。このように他のAPMと連携したトランザクションを、WhaTapは**マルチトランザクション**と定義します。**_TXトレース_**一覧で**マルチトランザクション**を含むトランザクションは、 <span class='mark multi'>M</span>アイコンを表示します。

    ![](/img/best-p/hitmap-transaction-sample-07.png)

    **_統計_**ウィンドウで**_マルチTXチャート_**ボタンを選択してください。トランザクションごとの連携情報をチャートで確認できます。**_マルチTXテーブル_**タブを選択すると詳細情報が確認できます。

    :::note

    -   マルチトランザクション追跡の詳細については、[次の文書](https://docs.whatap.io/java/trs-multi-trace)を参照してください。
    -   トランザクションによっては、**_マルチTXテーブル_**タブをサポートしない可能性があります。

    :::

## トランザクションログ分析

![](/img/best-p/hitmap-transaction-sample-06.png)

 **_統計_**ウィンドウの**_トランザクションログ_**タブでは、当該トランザクションが実行される間に記録されたログを通じて追加・改善すべき事項を探すこともできます。

## 最終作業

**_ヒートマップトランザクション_**でパターンを確認し、共通点を把握します。把握された共通点からメソッド区間を分析します。区間情報が足りない場合は、**アクティブスタック**を通じて追加情報を確保してください。次にSQL、メソッド、HTTPリクエスト情報を確認して繰り返し負担をかけるロジックの改善点を探してみてください。WhaTapモニタリングサービスの**_ヒートマップトランザクション_**を通じてモニタリング業務の効率を一段階引き上げることができます。

:::note 

**参考資料**

-   [月刊WhaTap：アプリケーションモニタリングプロファイルを活用する](https://www.whatap.io/ko/blog/71/)
-   [月刊WhaTap：個別トランザクション分布図をご覧になりたい場合は？](https://www.whatap.io/ko/blog/79/)
-   [月刊WhaTap：大切な休暇を守ってくれるWhaTapマシンラーニング](https://www.whatap.io/ko/blog/113/)
-   [WhaTap5分セミナー：ヒートマップの縦横ライン分析](https://youtu.be/JHVYfJjtYQo)

:::
