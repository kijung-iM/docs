---
id: docker
title: Docker
description: Docker環境でWhaTapエージェントの適用を完了してください。
tags:
  - Java
  - Docker
---

既存のDockerイメージに基づいて、WhaTapエージェント設定を追加したイメージをビルドしてください。

:::note
本文では、Javaエージェントをインストールする場合を扱います。WhaTap Kubernetesモニタリングとともに適用する場合は、別途の手続きを参考にしてください。
:::

1.  Dockerビルドディレクトリを作成してください。

    ```bash
    mkdir -p {Docker build dir}
    ```

2.  _whatap.conf_ファイルを作成してください。

    ```docker {3,5} showLineNumbers
    cat >{Docker build Dir}/whatap.conf <<EOL
    # アクセスキーを入力してください。
    license=XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX 
    # 収集サーバーのIP情報を入力してください。
    whatap.server.host=xx.xx.xx.xx/yy.yy.yy.yy 
    EOL
    ```

3.  Dockerfileを作成してください。\
    イメージをビルドする場合、WhaTapイメージから`-javaagent`オプションに適用するjarファイルをコピーすることができます。

    ```docker
    cat >/home/silver/whatap/docker/Dockerfile <<EOL
    FROM whatap/kube_mon as build
    ## 実際イメージの作成（既存のイメージにWhatapを追加）
    ## $Image_Name（イメージ名）
    FROM $Image_Name
    RUN mkdir -p /whatap
    COPY --from=build /data/agent/micro/whatap.agent-*.jar /whatap
    COPY ./whatap.conf /whatap/
    #...
    EOL
    ```

4.  `JAVA_OPT`に次を追加してください。

    ```bash
    WHATAP_HOME=/whatap
    WHATAP_JAR=ls ${WHATAP_HOME}/whatap.agent-*.jar | sort | tail -1
    export JAVA_OPTS="-javaagent:${WHATAP_JAR} "
    ```

5.  Dockerをビルドしてください。

    ```bash
    cd docker
    docker build -t $Image_Name
    ```

:::note
{@include: _java-17.mdx}
:::

:::note
Java 에이전트 파일 이름은 `Rename` 기능을 활용해 수정할 수 있습니다. Java 에이전트의 이름을 수정했다면 `JAVA_OPTS`에 새로운 Java 에이전트 이름을 등록하세요.

```bash title='Java 에이전트 이름 수정 방법 예시'
java -cp whatap.agent-X.Y.Z.jar whatap.agent.setup.Rename -from whatap.agent-X.Y.Z.jar -to whatap.agent.jar
```

:::
