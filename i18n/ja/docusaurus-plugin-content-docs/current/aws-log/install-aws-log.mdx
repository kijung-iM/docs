---
id: install-aws-log
title: インストール
description: WhaTap AWS Logサービス利用のための基本インストール方法について案内します。
tags:
  - AWS Log
  - インストール
---

import TR from '@site/src/components/TR';

{@include: ../getting-started/_how-to-start-intro.mdx} 

## 事前確認

AWS Logを収集するには、追加のリソースが必要です。ユーザーのAWS環境で出力されるログ情報を受信した後、WhaTap収集サーバーに転送できるようにするため、WhaTapはAWS Lambda Functionを通じて**WhaTap Forwarder**を提供します。AWS Cloud Formationを活用して**WhaTap Forwarder**をユーザーのAWS環境に駆動します。

**WhaTap Forwarder**はAWS Lambda FunctionのLifecycleに依存しています。 制御要素により、同時性の制約を克服できます。 ユーザー環境で発生するログ量に応じて、次の制御要素を調整します。

<!-- 
AWS Log를 수집하기 위해서는 사용자의 AWS 환경에서 출력되는 로그 정보를 입수 후 와탭 수집 서버로 전송할 수 있도록 부가적인 자원이 필요합니다. 와탭은 로그를 감지하고 전송하기 위해 **WhaTap Forwarder**를 AWS Lambda Function을 통해 제공합니다. AWS CloudFormation을 활용해 **WhaTap Forwarder**를 사용자의 AWS 환경에 구동합니다.

**WhaTap Forwarder**는 AWS Lambda Function의 Lifecycle에 의존적이기에 동시성 제약을 극복하기 위한 제어 요소를 가집니다. 사용자 환경에서 발생하는 로그량에 따라 다음과 같은 제어 요소를 조정해야 합니다.
와탭은 로그를 감지하고 전송하기 위해 와탭 포워더를 제공합니다.

와탭 포워더는 로그를 감지하고 전송합니다. 와탭 포워더가 로그를 감지하고 전송합니다.

와탭 포워더는 람다 펑션의 라이프사이클에 의존적이기에 동시성 제약 극복을 

-->

-   `ReservedConcurrency`： 同時実行数です。
-   `Timeout`：Lambda Functionにログ流入がない場合の保持時間です。
-   `Memory`：Lambda Functionに割り当てられるメモリです。
-   `ConnectionTimeout`：WhaTap収集サーバーにログを送信する時のタイムアウトです。

<details>
<summary>AWS LogがサポートするAWS Resource Log</summary>

#### CloudWatch Log Group

-   WAF
-   API Gateway：ロググループ名を**_api-gateway/gateway resource_**として設定してこそ、正常な収集が可能です。
-   RDS
-   DocumentDB
-   REDIS
-   EKS
-   ECS

#### S3

-   VPC：Logが収集されるS3 Bucket名を**_VPC resource_**として設定してこそ、正常な収集が可能です。
-   CloudFront：Log設定時に接頭辞を**cloudfront**として設定してこそ、正常な収集が可能です。
-   ELB

</details>

<!--  프로젝트 생성 -->

{@include: ../getting-started/_create-project-v2.mdx}  

{@include: ../getting-started/_accesskey.mdx}

:::note 

**プロジェクトアクセスキー**

すでに**プロジェクトアクセスキー**を発行している場合は、ボタンの代わりに発行されたキーが表示されます。

:::

## WhaTap Forwarderインストール

ログ転送用の**WhaTap Forwarder**をAWS Lambda Functionとしてインストールします。 AWS Cloud Formationでインストールを行います。 WhaTap**_エージェントインストール_** > **_インストール案内_**セクションの**_WhaTap Forwarderインストール_**タブを参照してください。 次のインストール入力情報が必要です。 

-   **AWS Region** <br/>
    WhaTap ForwarderをインストールするAWS Regionを選択してください。 収集対象リソースと同じRegionである必要があります。
-   **CloudFormation Stack Name**<br/>
    WhaTap Forwarderのインストールおよび削除に活用されるCloud Formation Stack名を指定します。
-   **ConnectionTimeOut**<span class='type'>Second</span><br/>
    デフォルト値`10`<br/>
    WhaTap ForwarderがWhaTap収集サーバーに接続する際、タイムアウト時間（秒）を指定します.
-   **MemorySize**<span class='type'>Int</span><br/>
    デフォルト値`1024`<br/>
    WhaTap Forwarderのメモリ割り当てサイズ（MB）を指定します。
-   **Timeout**<span class='type'>Second</span><br/>
    デフォルト値`150`<br/>
    WhaTap Forwarderの休止期間（秒）を指定します。 ログ転送リクエストがないときにLambda Functionが削除されるまでの時間を指定します。 
-   **UseReservedConcurrency**<span class='type'>Boolean</span><br/>
    デフォルト値`false`<br/>
    ログの安定的な転送のために、WhaTap Forwarderに割り当てる最大Function数の指定の可否を設定します。
-   **ReservedConcurrency**<span class='type'>Second</span><br/>
    デフォルト値`10`<br/>
    `UseReservedConcurrency`の値が`true`の場合、WhaTap Forwarderに割り当てるFunctionの個数を指定します。AWSアカウントごとにデフォルトで割り当てられるFunction数は1,000個です。ユーザが使用できるFunctionの総数は、アカウントあたりの総割り当てFunction個数（1,000）から`ReservedConcurrency`設定値を引いたものに制限されます。

    <!-- 사용자는 AWS 계정 당 할당 가능한 총 Function 개수에서 `ReservedConcurrency` 설정 값을 뺀 만큼 Function을 사용할 수 있습니다. -->

### CloudFormation Stackインストール

![WhaTap Forwarder](/img/aws-log-whatap-forwarder-install.png)
![WhaTap Forwarder create stack](/img/aws-log-create-stack.png)

1.  **_インストール案内_**セクションの![number 1](/img/number-01.png) **_WhaTap Forwarderインストール_**タブで![number 2](/img/number-02.png) **_AWS Region_**を選択してください。
2.  ![number 3](/img/number-03.png) **_WhaTap Forwarderインストールページ_** ボタンを選択し、CloudFormation実行ページに移動してください。
3.  CloudFormation実行ページでインストールオプションを指定してください。 デフォルトのパラメータは入力されています。
4.  下段から![number 4](/img/number-04.png)承認を**_チェック_**した後、![number 5](/img/number-05.png) **_Create stack_**ボタンを選択してください。 インストールには約2分かかります。

### WhaTap ForwarderのARN確保{#whatapforwarder-arn}

![WhaTap Forwarder arn1](/img/aws-log-whatap-forwarder-arn.png)

1.  上段右側の![number 1](/img/number-01.png)**_更新_**ボタンをクリックしてスタックの作成進行状況を確認してください。 
    :::note

    スタックインストールの最終段階であるWhaTapAWSLogの作成が進行中であれば、**WhaTapForwarder**の**ARN**を確保することができます。 

    :::

1.  Logical IDがWhaTapAWSLOGとして指定されたリソースの![number 2](/img/number-02.png)***Pyhsical ID***を選択し、**WhaTap Forwarder**の詳細画面に移動してください。
2.  詳細画面右側の***Description***領域で![number 3](/img/number-03.png)***Function ARN***(**WhaTap Forwarder ARN**)を確認することができます。
3.  次のステップのためにコピーしてください。

### インストール失敗時のチェックリスト

#### 権限設定

次のようなエラーメッセージが発生した場合、権限付与の有無を確認してください。

```bash
User {user name} is not authorized to perform
```

-   **必要権限**

    -   CloudFormationインストールのためのポリシー
    -   AWS Logコードをインポートするためのポリシー
    -   AWS Logを作成し、必要な権限を付与するためのポリシー
    -   AWS LogにPolicyを作成するためのポリシー

    ```bash title='AWS Log 필요 권한'
    {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "VisualEditor0",
              "Effect": "Allow",
              "Action": [
                  "iam:GetRole",
                  "iam:GetRolePolicy",
                  "iam:CreateRole",
                  "iam:PutRolePolicy",
                  "iam:PassRole",
                  "iam:AttachRolePolicy",
                  "cloudformation:ListStacks",
                  "cloudformation:DescribeStackResource",
                  "cloudformation:GetTemplateSummary",
                  "cloudformation:DescribeStacks",
                  "cloudformation:DescribeStackEvents",
                  "cloudformation:CreateStack",
                  "cloudformation:GetTemplate",
                  "cloudformation:ValidateTemplate",
                  "lambda:CreateFunction",
                  "lambda:InvokeFunction",
                  "lambda:GetFunction",
                  "lambda:AddPermission",
                  "s3:CreateBucket",
                  "s3:GetObject"
              ],
              "Resource": "*"
          }
      ]
    }
    ```

#### スタック名

次のようなエラーメッセージが発生した場合、Cloud Formationスタック名を変更してください。

```bash
Stack {stack name} already exists
```

## AWS IAMポリシーとロール作成

WhaTap ForwarderがユーザーのAWS環境リソースログを送信するには、**_IAMポリシー_**と**_IAMロール_**が必要です。 以前にWhaTap Forwarder設定用のIAMポリシーとIAMロールを作成したことがない場合は、新規作成してください。 

### IAMポリシーの作成{#create-iam-policy}

アクセス対象のリソースに対する許可または拒否を指定します。WhaTap**_エージェントインストール_** > **_インストール案内_**セクションの**_AWS IAMポリシー作成_**タブを参照して進めてください。 欠落したポリシーがある場合、設定は正常に行われません。

![IAMポリシー作成sc](/img/aws-log-create-policy.png)

1.  AWS Management Consoleにログインしてから、IAMコンソールを開きてください。 
2.  IAMコンソールで**_Policy_**タブを選択してください。
3.  **_Create Policy_**ボタンを選択し、次のポリシーをコピーしてから、![number 1](/img/number-01.png) **_JSON_**タブに貼り付けてください。

```bash title='IAM 정책'
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "s3:List*",
                "s3:PutBucketNotification",
                "s3:GetBucketNotification",
                "logs:PutSubscriptionFilter",
                "logs:DescribeLogGroups",
                "lambda:ListFunctions",
                "logs:DescribeSubscriptionFilters",
                "s3:GetBucketNotification"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "lambda:UpdateFunctionCode",
            "Resource": "*",
            "Condition": {
                "ForAllValues:StringEquals": {
                    "aws:TagKeys": "WhaTapForwarder"
                }
            }
        },
        {
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": [
                "arn:aws:s3:::whatapforwarder",
                "arn:aws:s3:::whatapforwarder/whatap.zip"
            ]
        }
    ]
}
```

1.  下段の![number 2](/img/number-02.png) **_Review Policy_**ボタンをクリックしてください。
2.  ![number 3](/img/number-03.png)ポリシー名を指定してください。
3.  下段の![number 4](/img/number-04.png) **_Create Policy_**ボタンを選択してください。

:::note

**IAMポリシー内の権限**

当該IAMポリシーには、次のような権限が指定されています。

-   S3保存リストの照会権限
-   S3バケットにオブジェクトを搭載する際、通知取得に関する権限
-   CloudWatch Logサブスクリプションフィルタ権限
-   CloudWatch Logグループの照会権限

:::

### IAMロールの作成{#create-iam-role}

<!-- 어떤 AWS 계정 ID로 생성된 자원에 대해 권한을 허용할지를 지정하고 직전에 생성한 IAM 정책을 매핑합니다. -->

作成されたリソースの権限をどのAWSアカウントに許可するかを指定し、直前に作成したIAMポリシーをマッピングします。 WhaTap**_エージェントインストール_** > **_インストール案内_**セクションの**_AWS IAMロール作成_**タブを参照して進めてください。 

<!-- 

![IAM Role sc](/img/aws-log-iam-role-v.png) 
1. ***Account ID***에 와탭 계정(**911937781722**)을 입력하세요.

-->

1.  AWS Management Consoleにログインしてから、IAMコンソールを開きてください。
2.  コンソール探索ウィンドウで**_Roles_**を選択してから、[number 1](/img/number-01.png)**Create role**ボタンを選択してください。 <br/>
    ![IAM Role 1](/img/aws-log-iam-role-create.png)
3.  **_Select type of trusted entity_**から![number 2](/img/number-02.png) **_AWS account_**を選択し、![number 3](/img/number-03.png) **_Account ID_**にWhaTapアカウント(**911937781722**)を入力してください。<br/>
    ![IAM Role 2](/img/aws-log-iam-role-account.png)
4.  下段の**_Next_**ボタンを選択してください。
5.  [既存のステップ](#create-iam-policy)から作成した![number 4](/img/number-04.png) **IAMポリシー**を選択してください。<br/>
    ![IAM Role 3](/img/aws-log-iam-role-policy.png)
6.  下段の**_Next_**ボタンを選択してください。
7.  IAMロールの![number 5](/img/number-05.png)名前を入力してください。<br/>
    ![IAM Role 4](/img/aws-log-iam-role-name.png)
8.  **_Create Role_**ボタンを選択してください。
9.  情報タブで作成された![number 6](/img/number-06.png) **_IAM Role ARN_**が確認できます。<br/>
    ![IAM Role 5](/img/aws-log-iam-role-arn-c.png)
10. 次のステップのため、**_IAM Role ARN_**をコピーしてください。 

## AWS Logのサブスクリプション

:::note

CloudWatch LogとS3に搭載されるArchive Logを購読することができます。

:::

### AWS CloudWatch Logの照会およびサブスクリプション

WhaTap**_エージェントのインストール_** > **_インストール案内_**セクションの**_AWS Resource Logの照会およびサブスクリプション_**タブで上段の***AWS Cloud Watch Log Group***を選択して進めてください。 

![AWS CloudWatch Logの照会およびサブスクリプションsc](/img/aws-log-cloudwatch-subs.png)

1.  AWS Logがインストールされた![number 1](/img/number-01.png) **_AWS Region_**を選択してください。 
2.  [기존 단계](#whatapforwarder-arn)에서 획득한 **WhaTap Forwarder ARN**을 복사 후![number 2](/img/number-02.png) **_AWS IAM Role ARN_**에 붙여넣기 하세요.
3.  ![number 3](/img/number-03.png) **_照会_**ボタンを選択してから、サブスクリプションできるAWSリソースを照会してください。
4.  照会されたリソースのうち![number 4](/img/number-04.png)サブスクリプションする対象を選択してください。
5.  ![number 5](/img/number-05.png) **_登録_**ボタンを選択してください。

:::note

**照会およびサブスクリプションに失敗した場合**

-   **_IAM Role Policy_**に欠けたポリシーがないかを確認してください。
-   **_IAM Role_**作成過程で信頼ポリシーを正確に設定したことを確認してください。

:::

### AWS S3 Bucketのサブスクリプション

WhaTap**_エージェントインストール_** > **_インストール案内_**セクションの**_AWS Resource Log照会およびサブスクリプション_**タブで上段の***AWS3 Bucket***を選択して進めてください。 

![AWS S3 Bucketの照会およびサブスクリプションsc](/img/aws-log-s3-subs.png)

1.  AWS Logがインストールされた![number 1](/img/number-01.png) **_AWS Region_**を選択してください。 
2.  [기존 단계](#whatapforwarder-arn)에서 획득한 **WhaTap Forwarder ARN**을 복사 후 ![number 2](/img/number-02.png) **_AWS IAM Role ARN_**에 붙여넣기 하세요.
3.  ![number 3](/img/number-03.png) **_照会_**ボタンを選択してから、サブスクリプションできるAWSリソースを照会してください。
4.  照会されたリソースのうち![number 4](/img/number-04.png)サブスクリプションする対象を選択してください。
5.  ![number 5](/img/number-05.png) **_登録_**ボタンを選択してください。

## モニタリングの開始

![AWS Logモニタリングの開始](/img/aws-log-start.png)

インストールを完了した後、**_管理_** >**_ログ設定_**メニューに移動してください。 **_ログモニタリングの開始_**セクションで**_ログモニタリングサービスのアクティブ化_**トグルボタンをクリックし、AWS Logモニタリングを開始してください。 

-   ![アイコン](/img/ic-toggle-on.svg)トグルボタンをオンにすると、ログモニタリンがアクティブになります。
-   ![アイコン](/img/ic-toggle-off.svg)トグル ボタンをオフにすると、ログモニタリンが非アクティブになります。 ログをこれ以上保存しません。

モニタリングがアクティブ化されると、**_ダッシュボード_** > **_ライブテール_**メニューから流入されるログの出力を確認することができます。

:::note

프로젝트에 대한 **수정 권한**이 있는 경우에만 로그 모니터링을 활성화할 수 있습니다. 권한에 대한 자세한 내용은 [다음 문서](../project/project-structure)를 참조하세요.

:::
