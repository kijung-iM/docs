<!-- 와탭 에이전트는 트랜잭션 트레이스 정보, 통계 정보 외 애플리케이션 성능과 관련된 다양한 정보를 수집하며 이는 크게 3가지로 분류할 수 있습니다. -->

WhaTapエージェントは、アプリケーションのパフォーマンスに関するさまざまな情報を収集します。情報は、大きく3つに分類できます。

-   **User**：リアルタイムユーザーまたは訪問ユーザー

-   **Service** ：トランザクション、SQL、外部呼び出し件数および応答、エラー率など

-   **Resource**：システム、プロセスリソースの使用量

## User Counter

ユーザーとは、モニタリング対象システムを使用するクライアントを意味します。クライアントでは、一般的にブラウザに基づいてユーザー数を計算します。

ウェブシステムのパフォーマンスでは、ユーザーは負荷を発生させる起点であるため、重要です。ユーザー追跡のためには、ユーザーをどのような基準で区分し、どのようにカウントするかについての考慮が必要です。

### ユーザー区分

WhaTapエージェントのユーザーを区別するためにさまざまなオプションを提供します。

-   **Remote IP**<br/>
      デフォルト値はremote ipを使用してユーザーを区別します。 remote ipは実際のユーザーを区別するのに限界があります。

-   **Cookie**<br/>
      クッキーを使用してユーザーを区別します。 すべての接続クライアントを対象に**WHATAP**というクッキーにUUIDを保存します。

    ```ini title='whatap.conf'
    whatap.trace_user_using_ip=false
    ```

-   **Header Key**<br/>
      http headerに渡される値でユーザーを区別できます。

    ```ini title='whatap.conf'
    whatap.trace_user_header_ticket=USER
    ```

### ユーザーカウント

ユーザーをカウントする方法によって異なります。リアルタイムユーザーは、現在システムを使用しているユーザーの数を知るために測定します。日間訪問ユーザーは、1日中にそのサービスに関心を持つユーザーが何人いるかをビジネス管理するために測定します。

-   **リアルタイムユーザー**\
      最近5分間のユーザー数をカウントします。 5秒ごとにshiftingすると、ユーザーをカウントします。 各サーバーでカウントされた数字は、HyperLogLogアルゴリズムによってマージされます。

-   **一日訪問者**(**DAU**, Daily Active User)\
      1日の間にシステムに接続したユーザーをカウントします。 24時間の間に接続したユーザーをHyperLogLogを通じて計算します。

:::tip
WhaTapでは、長期間ユーザーをカウントするために、ユーザーデータに対するbyte blockをサーバーで収集します。このデータをHyperloglogでマージすると、理論的には1ヶ月以上の訪問ユーザーを計算できます。
:::

## Service Counter

トランザクションとトランザクションが使用するSQLまたは外部呼び出しなどの件数、応答時間エラー件数などに対するパフォーマンス指標が含まれます。

-   **Transaction Counter**<br/>
      トランザクションを実行すると測定するカウンターです。
    -   **件数**
    -   **応答時間**
    -   **エラー件数**  

-   **Active Transaction Counter**<br/>
      進行中のトランザクションの数をカウントします。
    -   **件数**
    -   **Active Status**<br/>
          進行状態はMETHOD, SQL, HTTPC, DBC, SOCKET5つの状態で固定されています。
        -   METHOD - 一般関数を呼び出す状態
        -   SQL - DB SQL実行中の状態
        -   HTTPC - 外部HTTP API(サービス)を呼び出し中の状態
        -   DBC - DB接続を要求した状態、一般的にPoolから取得
        -   SOCKET - TCPセッションに接続を要求している状態

-   **SQL**<br/>
      SQLの実行状況をカウントします。
    -   **件数**
    -   **応答時間**
    -   **エラー件数**
    -   **パッチ回数**

-   **HTTP Call**<br/>
      外部HTTP呼び出しの現況をカウントします。
    -   **件数**
    -   **応答時間**
    -   **エラー件数**   

## Resource Counter

サーバーリソースまたはNodeプロセス内のリソース使用量をカウントします。

* * *

-   **CPU** (sys, usr, wait, steal, irq, cores)<br/>
      CPUの使用率(%)です。各種類別に収集されます。仮想環境だけでStealが意味を持ちます。Cpu Coreの個数を一緒に収集しています。　　

-   **Process CPU**<br/>
      プロセスが使用するCPUの使用率です。

-   **Memory**<br/>
      システムメモリの使用率(%)です。

-   **Swap**<br/>
      Swapメモリの使用率(%)です。

-   **Disk**<br/>
    DiskはProcessのCurrentディレクトリの使用率（％）です。

-   **Heap** (Total, Used, Perm)<br/>
      Heapメモリ内のTotal、Used、Perm量です。 データ単位はKBytesです。

-   **DB Connection Count**<br/>
      Connection Poolのカウントを収集します。

* * *

## Apdex

![](https://img.whatap.io/media/agent_php/data/tinified/apdex.png)

Apdex(Appliccation Performance Index)は、オープン標準に従うアプリケーションのパフォーマンス指標です。Apdexは応答時間に基づいており、全体の要求の中で満足と許容の割合で数値化します。 ダッシュボードにApdexグラフが追加されました。 

Apdexはユーザー満足度の指標として活用でき、0~1の間の値を持ちます。

> （満足回数+（許容回数\*0.5））／全体リクエスト数

| 状態                    | 説明                                     |
| --------------------- | -------------------------------------- |
| 満足(Satisfied, **S**)  | 業務処理に全く問題なし≤ 1.2秒(満足**S**デフォルト値)       |
| 許容(Tolerating, **T**) | 使用者が遅延を感じるが業務処理は可能≤ 4.8秒(満足**S** \* 4) |
| 不満(Frustrated, **F**) | 業務処理が不可能> 4.8秒(許容**T**超過及びエラー)         |

-   **whatap.apdex_time**<span class='type'>millisecond</span><br/>
      デフォルト値`1200`<br/>
      満足**S**デフォルト値は、エージェント設定メニューから変更できます。
