ホーム画面 > プロジェクト選択 > **_警告通知_** > **_イベント設定_** >**メトリクス**タブ選択

## メトリクスイベントとは

メトリクスイベントは、基本イベント（アプリケーションイベント、サーバーイベントなど）より具体的で複雑なイベントを設定する時に使用します。プロジェクトにおいてリアルタイムで収集中のメトリクスデータに基づいてイベントを設定できます。使用に応じて、2つの設定方法のいずれか1つを選択してイベントを設定できます。

-   メトリクスイベント
-   複合メトリクスイベント

:::note
メトリクスの詳細については、[次の文書](metrics-intro)を参照してください。
:::

## メトリクスイベント

**_警告通知_** > **_イベント設定_**メニューの画面の上の**_メトリクス_**を選択してください。画面右上の **_+イベント追加_**を選択してください。**_メトリクスイベント_**ウィンドウが表示されます。

![メトリクスイベント](/img/set-events-metrics.png)

### 基本情報入力

-   **_イベント名_** ：追加するイベント名を入力してください。

-   **_イベント活性化_**：イベントの活性化有無を選択してください。

-   **_テンプレート_**：作成されたテンプレートを選択して、迅速かつ簡単にイベントを設定できます。テンプレートを使用しない場合は、**_使用しない_**を選択してください。

-   **_カテゴリ_**：メトリクス データを区切る単位です。メトリクスイベント設定時の必須のオプションの値です。

    ![メトリクスイベント - カテゴリ](/img/set-event-select-category.png)

    -   **_カテゴリー_**選択オプションには、![指示線1](/img/number-01.png) **_名前_**科![指示線2](/img/number-02.png)データ収集間隔、![指示線3](/img/number-03.png) **_キー_**情報を表示します。イベント設定時に、そのカテゴリのキー値を使用します。
    -   **_カテゴリ_**には、最近3時間範囲内のプロジェクトで収集中のメトリクスデータを照会して一覧に表示します。**_カテゴリ_**選択オプションに収集間隔が表示されない場合は、**_直接入力する_**オプションを選択してカテゴリキーを入力できます。

-   **_レベル_**

    -   イベント発生時の警告レベルを示します。<span class='vslow'>Critical</span>, <span class='slow'>Warning</span>、<span style={{color:'#757575'}}>Info</span>レベルに分けられます。<span class='vslow'>Critical</span>、<span class='slow'>Warning</span>レベル設定時**_イベントの状態が解決したら追加通知_**選択オプションが活性化されます。

    -   **_イベントの状態が解決したら追加通知_**：イベント項目中に発生したイベントの状態が解決したら、追加通知の送信有無を選択できます。トグルボタンを選択して機能をオン・オフにすることができます。

-   **_メッセージ_**

    -   イベント発生時に出力する通知メッセージを入力します。 `${タグまたはフィールドキー}` を入力してメッセージに変数を適用できます。変数に入力するキーは、選択したメトリック データ**_カテゴリ_**に含まれる値である必要があります。
    -   ![時間アイコン](/img/ico-timing.svg)ボタンをクリックすると、以前に入力したメッセージ履歴を確認できます。
    -   **_受信テスト_**は、**_イベント名_**、**_カテゴリ_**、**_レベル_**、**_メッセージ_**情報を基準に通知を発生させ、メッセージをチェックする機能です。

-   **_イベント発生条件_**<br/>
    ![イベント発生条件](/img/set-event-condition.png)

    ![指示線1](/img/number-01.png)フィールド、![指示線2](/img/number-02.png)演算子選択、![指示線3](/img/number-03.png)しきい値を入力して、イベント発生条件を設定してください。

-   **_イベント対象フィルタリング_**<br/>
    ![イベント対象フィルタリング](/img/set-event-filtering.png)

    ![指示線1](/img/number-01.png)タグ、![指示線2](/img/number-02.png)演算子選択、![指示線3](/img/number-03.png)フィルタリング値を入力してターゲットをフィルタリングします。入力値がない場合は、全体エージェントに対して警告通知を送信します。

:::note

-   **_イベント発生条件_**と**_イベント対象フィルタリング_**で使用できる基本文法と演算子の一覧は[次の文書](#condition-guide)を参考にしてください。

-   **_イベント発生条件_**と**_イベント対象フィルタリング_**オプションは、**_選択入力_**または**_直接入力_**モードを選択できます。

-   イベント設定内容が保存された後、そのオプション値は**_直接入力_**モードで管理します。以後**_選択入力_**モードに切り替えると、オプション値が初期化される場合があります。

:::

### **_イベント受信設定_**

![イベント受信設定](/img/set-event-receive.png)

-   **_発生回数_**：選択した時間の間に**_イベント発生条件_**で設定したイベントが入力回数だけ発生すると、警告通知を送信します。

    :::note

    -   選択時間を**_使用しない_**に設定すると、入力した回数だけ連続発生した時に通知を送信します。
    -   **_イベントの状態が解決したら追加通知_**オプションを活性化した場合、選択時間は**_使用しない_**を選択することをお勧めします。
    -   **_カテゴリ_**オプションで選択した項目の収集周期は5秒です。
    :::

-   **_イベント発生の一時停止_**：過度な警告通知の発生を防止できるオプションです。 最初の警告通知以降、選択した時間帯に警告通知を送信しません。 また、**_イベント記録_**メニューに記録されません。

-   **_関連カテゴリ_**：関連カテゴリを5つまで設定し、通知を照会する時に参考にします。

-   **_イベント受信タグ_**：イベント受信タグを選択すると、該当タグを持つプロジェクトメンバーと3rd-partyプラグインに通知を送信できます。イベント受信タグを選択しない場合は、プロジェクトの全体メンバーに警告通知を送信します。

    :::note
    **_警告通知_** > **_イベント受信設定_**メニューでプロジェクトメンバーと3rd-partyプラグインにタグを設定できます。
    :::

### **_通知ルールテスト_**

![警告通知テスト](/img/set-event-test.png)

選択した時間に設定したイベント条件を実行し、何回の警告通知が発生したかを確認できます。実行ボタンを選択すると通知発生の件数情報が分かり、イベント発生条件で選択したフィールドとしきい値をチャート上に表示します。

## 複合メトリクスイベント

**_複合メトリクスイベント_**を利用するには、次の概念に対する理解が必要です。

-   [メトリクスとは](metrics-intro)
-   [MXQL](../mxql/mxql-overview)

**_複合メトリクスイベント_**は、メトリクスデータに対し、より複雑なルールを活用してイベントを作成し、警告通知を送信できます。複合メトリクスは、次のような状況で効果的に使用できます。

-   複数のエージェントから受信されたデータに対して総合的なイベント判定を行う必要がある場合
-   過去のデータと現在のデータを比較してイベント判定を行う必要がある場合

メトリクスイベントは、エージェントからメトリクスを受信するたびにイベント判定を行います。それに対し、複合メトリクスイベントは、各エージェントから収集されたメトリクスをデータベースに保存します。そして、もう一度照会してイベント判定を行います。このような特性から、複数のエージェントのデータを総合的に活用したり、過去のデータを活用することができます。 しかし、**MXQL**というWhaTap固有のデータ照会言語を使用しなければならないという進入障壁が存在します。したがって、ユーザーが基礎的なレベルの**MXQL**を理解するだけでも効果的にイベントを設定できるようにイベントテンプレートを提供します。MXQLの基礎ユーザーは、イベント対象フィルタリングとイベント条件に対するクエリを修正するだけでイベントを適用することができます。

1.  **_警告通知_** > **_イベント設定_**メニューで画面上の**_メトリクス_**を選択してください。 

2.  **_複合メトリクス_**セクションの右側の**_+イベント追加_**を選択してください。 

3.  **_複合メトリクス_**ウィンドウが表示されたら**_チャートで生成_**を選択してください。

イベント設定ウィンドウが表示されます。 

![複合メトリクスイベント設定](/img/set-event-cmetric.png)

:::note
複合メトリクスイベントを設定するには、**イベント設定**権限が必要です。
:::

### **_イベントデータ照会_**

**_複合メトリクスイベント_**は、メトリクスデータクエリ言語である**MXQL**に基づいてイベント条件を生成します。**_チャートで生成する_**機能は、**MXQL**の自動完成のためのコンボボックス機能を提供します。イベントデータを照会してチャートを構成し、イベント発行条件を直接入力するためのテンプレートです。**_ウィジェット_**または**_テキスト_**オプションを選択してイベントを設定してください。

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
<TabItem value='widget' label='위젯'>

時系列チャートを構成するオプションにより、イベント設定時に使用する**MXQL**を自動完成させることができます。

![イベントデータ照会](/img/set-event-data-view.png)

-   **_フィルター_**：イベント条件対象を選択します。![指示線1](/img/number-01.png)演算式、![指示線2](/img/number-02.png)タグ、![指示線3](/img/number-03.png)フィルタリング値を入力してフィルタリング条件を生成します。<br/>![フィルター](/img/set-event-cmetric-filter.png)

-   **_グループ化_**：グループ化されたメトリクスデータを選択します。複数選択できます。

-   **_タイムユニット_**：グループ化されたデータを分割する時間基準を設定します。**_秒_**、**_分_**、**_時間_**単位で選択して設定することができます。

-   **_フィールド_**：イベント発行条件に使用するフィールドを選択します。複数選択が可能です。

</TabItem>
<TabItem value='text' label='텍스트'>

**MXQL**を平文のまま修正できる編集ウィンドウが表示されます。

![メトリクスイベント - テキスト](/img/set-event-metrics-text.png)

</TabItem>
</Tabs>

### **_通知_**

警告通知設定の基本情報を入力します。

-   **_イベント活性化_**：トグルボタンをクリックして、イベントの活性化有無を選択できます。

-   **_レベル_**：<span class='vslow'>危険（Critical）</span>、<span class='slow'>警告（Warning）</span>、<span style={{color: '#757575'}}>情報</span>レベルのいずれか1つのレベルを選択してください。<br/>**_イベントの状態が解決したら追加通知_**：イベント項目中に発生したイベントの状態が解決したら、追加通知の送信有無を選択できます。トグルボタンを選択して機能をオン・オフにすることができます。

-   **_タイトル_**：警告通知のタイトルを入力してください。

-   **_メッセージ_**：イベント発生時に出力する通知メッセージを入力します。 `${タグまたはフィールドキー}` を入力してメッセージに変数を適用できます。 変数に入力するキーは、選択した複合メトリクスデータ**_カテゴリ_**に含まれる値である必要があります。

### **_イベント発行条件_**

警告通知を送信する条件を入力します。

-   **_データ照会範囲_**：イベント条件に使用する**MXQL**のリアルタイムデータ照会範囲を設定します。イベントデータの照会に含まれるフィールドのみ使用できます。<br/>
    複合メトリクスイベントは、DBに保存されているメトリクスを照会して活用します。したがって、データを照会する時間範囲から指定する必要があります。データ照会時間を5分で選択すると、最近5分間に収集されたデータを照会してイベント発生条件を確認します。最近のデータに対してイベントを設定する場合は短く、広い時間帯に対して統計的にアクセスしたい場合は長く設定できます。実際の使用例については、[次の文書](#template)を参考にしてください。

-   **_条件_**：MXQLに反映したフィールドと演算ルール、しきい値を入力します。

### **_付加情報_**

警告通知の受信に関連する追加オプションを設定します。

-   **_インターバル_**：選択した時間間隔で通知条件を確認します。

-   **_無音_**：過度な警告通知の発生を防止できるオプションです。 最初の警告通知以降、選択した時間帯に警告通知を送信しません。また、**_イベント記録_**メニューに記録されません。

-   **_イベント受信タグ_**：イベント受信タグを選択すると、該当タグを持つプロジェクトメンバーと3rd-partyプラグインに通知を送信できます。イベント受信タグを選択しない場合は、プロジェクトの全体メンバーに警告通知を送信します。

    :::note
    **_警告通知_** > **_イベント受信設定_**メニューでプロジェクトメンバーと3rd-partyプラグインにタグを設定できます。
    :::

### **_イベントルールテスト_**

![イベントルールテスト](/img/set-event-cmetric-test.png)

選択した時間に設定したイベント条件を実行し、何回の警告通知が発生したかを確認できます。実行ボタンを選択すると通知発生の件数情報が分かり、イベント発生条件で選択したフィールドとしきい値をチャート上に表示します。

イベント設定に含まれているほとんどの内容は、**MXQL**を使用して指定されます。**MXQL**が適切に作成されているかシミュレーションできる機能を提供します。シミュレーション機能は、過去24時間のデータを照会してイベント判定をした後、何件のメトリクスが照会され、そのうち何件でイベント判定が成功したかを知らせてくれます。

## メトリクスイベントの修正と削除

1.  **_警告通知_** > **_イベント設定_**メニューに移動した後**_メトリクス_**タブを選択してください。 

2.  イベント一覧から修正または削除しようとする項目の一番右側の![編集アイコン](/img/ico-edit.svg)ボタンを選択してください。

3.  メトリクスまたは複合メトリクスイベント設定ウィンドウが表示されたら、各オプションを修正し、**_保存_**ボタンを選択してください。

  選択したイベントを削除するには、イベント設定ウィンドウの右上の![削除アイコン](/img/ico-trash.svg) **_削除_**ボタンを選択してください。

## 発生条件、対象選択ガイド{#condition-guide}

メトリクス警告通知イベントの発生条件とイベント対象選択は、同じ文法を使用します。ただ、イベント発生条件は、タグ（Tag）のKeyを変数として使用し、イベント対象選択は、フィールド（Field）のKeyを変数として使用します。

### 基本文法

-   文字列をそのまま入力すると変数、バッククォート(' ')またはダブルクォート('' ")で囲むとtextとして認識します。

    ```java title='oid == "oid"'
    1. oid : 変数
    2. == : 関数
    3. "oid" : text
    ```

    ```java title='oname이 ott-1235일 경우'
    // 正常な場合
    onname = 'ott-1235'またはonname = "ott-1235"

    // 異常な場合、通知は動作しません。
    onname = ott-1235
    ```

-   数字をそのまま入力するとnumber、バッククォート(' ')またはダブルクォート('' '')で囲むとtextとして認識します。

    ```java title='oid == 123'
    1. oid : 変数
    2. == : 関数
    3. 123 : number
    ```

    ```java title='oid가 123일 경우'
    // 正常な場合
    oid = 123

    // 異常な場合、通知は動作しません。
    id == '123' 또는 oid == "123"
    ```

### 使用可能なオペレーター一覧

|   オペレーター       | 使い方                           | 説明                                                                                            |
| :------------: | ----------------------------- | --------------------------------------------------------------------------------------------- |
|    ==          | operand1 == operand2          | operand1とoperand2の値が同じか確認します。                                                                 |
|    !=          | operand1 != operand2          | operand1とoperand2の値が違うか確認します。                                                                 |
| <span>></span> | operand1 > operand2           | operand1の値がoperand2の値より大きいか確認します。                                                             |
|    > =         | operand1 >= operand2          | operand1の値がoperand2の値より大きいか同じかを確認します。                                                         |
|    \<          | operand1 \< operand2          | operand1の値がoperand2の値より小さいか確認します。                                                             |
|    \<=         | operand1 \<= operand2         | operand1の値がoperand2の値より小さいか同じかを確認します。                                                         |
|    like        | operand1 like operand2        | operand1をKeyとするValueがoperand2で始まるか終わるかを確認します。                                                 |
|    &&          | expression1 && expression2    | expression1とexpression2の両方が`true`であるかを確認します。                                                  |
|    and         | expression1 and expression2   | expression1とexpression2の両方が`true`であるかを確認します。<br/>**&&**と同じ役割を果たすオペレーターです。                     |
|     ||         | expression1 || expression2    | expression1またはexpression2が`true`であるかを確認します。                                                   |
|    or          | expression1 or expression2    | expression1またはexpression2が`true`であるかを確認します。<br/>**||**と同じ役割を果たすオペレーターです。                      |

#### likeの使い方

`startsWith`関数と`endsWith`関数の機能を便利に使用できるよう`like`オペレーターを追加しました。

-   `startsWith`の代わりに`like`オペレーターを使用

    ```java
    startsWith(Key, "Value")

    // like演算子
    Key like "Value*"
    ```

-   `endsWith`の代わりに`like`オペレーターを使用

    ```java
    endsWith(Key, "Value")

    // like演算子
    Key like "*Value"
    ```

-   `startsWith`と`endsWith`に同時対応

    ```java
    Key like "*Value*"
    ```

-   文字列の途中には、\*が使用できません。

    ```java
    // 対応文法
    Key like "tag*lue"
    ```

-   `like`演算子から\*が省略される場合は、==として動作します。

    ```java
    // 以下の2つの文章は全く同じ結果を出します。
    Key like "Value"

    Key == "Value"
    ```

### 使用可能なメソッド一覧

| メソッド                      | 使い方                        | 説明                                                                      |
| ------------------------- | -------------------------- | ----------------------------------------------------------------------- |
| [startsWith](#startwith)  | startsWith(param1, param2) | param1をKeyとするValueがparam2で始まると`true`、反対の場合は`false`                      |
| [endsWith](#endsWith)     | endsWith(param1, param2)   | param1をKeyとするValueがparam2で終わると`true`、反対の場合は`false`                      |
| [isNull](#isnull)         | isNull(param1)             | param1が`null`なら`true`、反対の場合は`false`                                     |
| [isNotNull](#isnotnull)   | isNotNull(param1)          | param1が`null`でなければ`true`、反対の場合は`false`                                  |
| [isEmpty](#isempty)       | isEmpty(param1)            | param1が`null`または`EmptyString("")`なら`true`、反対の場合は`false`                 |
| [isNotEmpty](#isnotempty) | isNotEmpty(param1)         | param1が`null`でもなく`EmptyString("")`でもなければ`true`、反対の場合は`false`            |

#### startsWith{#startwith}

```java
startsWith(Key, "Value")
```

#### endsWith{#endswith}

```java
endsWith(Key, "Value")
```

#### isNull{#isnull}

```java
isNull(Key)
```

#### isNotNull{#isnotnull}

```java
isNotNull(Key)
```

#### isEmpty{#isempty}

```java
isEmpty(Key)
```

#### isNotEmpty{#isnotempty}

```java
isNotEmpty(Key)
```

## テンプレート{#template}

![複合メトリクス - テンプレート](/img/set-event-cmetric-template.png)

-   複数のエージェントから受信されたデータに対して総合的なイベント判定を行う必要がある場合

    -   **_Inactive agents has been found._**
    -   **_Very slow active transactions detected._**

-   過去のデータと現在のデータを比較してイベント判定を行う必要がある場合 

    **_TPS has changed by more than 30% compared to the previous week._**

### **_Inactive agents has been found._**

-   プロジェクトに含まれるすべてのエージェントのうち、正常状態のエージェント数が6つ未満でイベントが発生すると、警告通知を送信します。
-   条件：`num_of_current_agents` \< 6

### **_Very slow active transactions detected._**

-   プロジェクトに含まれる特定の`okind`に属するエージェントで8秒以上かかるトランザクションの数の合計が10個を超えると警告通知を送信します。
-   条件：`very_slow_tx_cnt_m5_avg` > 10

### **_TPS has changed by more than 30% compared to the previous week._**

-   プロジェクトに含まれている特定の`okind`に属するエージェントのTPS合計が7日前と比べて30%以上変わると警告通知を送ります。
-   条件：`one_week_diff_abs` > `current_tps` \* 0.3
