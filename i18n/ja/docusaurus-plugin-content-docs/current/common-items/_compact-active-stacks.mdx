## コンパクトなアクティブスタックの収集

アクティブスタックはスレッドダンプを定期的に実行するため、誤って実装されるとエージェントのオーバーヘッドが大きくなる可能性があります。WhaTapはエージェント負荷を最小限に抑えながらアクティブスタックを収集するための様々なオプションを持っています。

:::tip
**_サイトマップ_** > **_スレッド一覧／ダンプ_**メニューからスレッドリストの中で**_WhaTap-ActiveStackDump_**スレッドの**_CPU Time_**を確認するとオーバーヘッドが判断できます。
:::

**アクティブスタックの例**

```javascript title='JAVA'
java.lang.StringBuffer.append(StringBuffer.java:309)
java.util.regex.Matcher.appendReplacement(Matcher.java:839)
java.util.regex.Matcher.replaceAll(Matcher.java:906)
java.lang.String.replaceAll(String.java:2162)
core.log.triggers.TriggerRegister.changeNotify(TriggerRegister.java:114)
core.log.aop.handler.DaoInfo.log(DaoInfo.java:141)
core.log.aop.handler.DaoInfo.doAround(DaoInfo.java:102)
core.log.aop.reflection.profiler.AroundProfiler.invoke(AroundProfiler.java:19)
com.sun.proxy.$Proxy39.getUpdateCount(Unknown Source)
org.apache.ibatis.executor.resultset.DefaultResultSetHandler.getNextResultSet(DefaultResultSetHandler.java:256)
org.apache.ibatis.executor.resultset.DefaultResultSetHandler.handleResultSets(DefaultResultSetHandler.java:193)
org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:64)

---

sun.reflect.GeneratedMethodAccessor140.invoke(Unknown Source)
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
java.lang.reflect.Method.invoke(Method.java:606)
org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221)
org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136)
org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:114)
org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:827)
```

**最適化されたデータ収集**

-   トランザクションを実行しているスレッドに限ってスタックをダンプします。

-   アクティブスタックのダンプ間隔を調整することができます。
    `active_stack_second=10`

-   アクティブスタックの最大ラインに制限されています。 Topラインからデフォルト値として50ラインを収集します。
      `trace_active_callstack_depth=50`

-   アクティブスタックの各行はハッシュ処理されて収集されます。テキストは1回だけ収集されます。 
    <!-- 문의 -->

-   一回に収集される最大アクティブスタックの数も制限されています。
       `active_stack_count=100`
