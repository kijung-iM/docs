## Network & security

WhaTapは、エージェントにサーバーの方向をTCP接続してから、モニタリングデータを転送します。

![WhaTapエージェントのネットワーク](https://img.whatap.io/media/agent_node/agent_net.png)

エージェントは、1つのTCP セッションを介してデータ転送とサーバーの制御要求を処理します。 NodeエージェントはUDPを使用しません。 NodeエージェントからWhaTap収集サーバー方向にファイアウォールを開放します。

### 収集サーバーのアドレスとポート

WhaTapサーバーは、データリージョンサーバーとフロントサーバー、ユーレカなどに区分します。データリージョンにはProxy、Yard、Gateway、Keeperなどがあります。エージェントは、その中でProxyサーバーと通信します。

NodeエージェントにWhaTapサーバのproxyサーバのアドレスを設定します。（exwhatap.server.host=10.0.3.1/10.0.3.2）サーバアドレスを設定するときは、proxyサーバ数だけ入力します。WhaTapサーバは、インストール方法によってproxyサーバを1つまたは複数使用できます。

WhaTap Proxyサーバは6600番ポートでリスニング（Listening）します。エージェントから別設定をしない場合、エージェントは6600番ポートへの接続を試みます。

```ini title='whatap.conf 포트 설정'
whatap.server.port=6600
```

:::note
2つのProxyサーバーが異なるポートを使用できません。複数台のProxyサーバーを使用する場合、リスニングポートは同一である必要があります。
:::

### 通信接続およびセキュリティ

WhaTapは、パブリックネットワークからモニタリングデータを収集することを前提に設計されました。したがって、すべてのモニタリングデータを暗号化してサーバーに転送します。多くのデータを暗号化転送すると、オーバーヘッドを引き起こす可能性があります。WhaTapはデータを選別的に暗号化します。エージェントとサーバー間の通信プロセスは次のとおりです。

1.  プロジェクト作成メニューからプロジェクトアクセスキーを作成してから、コピーしてください。
2.  プロジェクトアクセスキーにはパスワードが含まれます。外部に知らされないように注意してください。
3.  アプリケーションサーバーを再起動してください。
4.  WhaTapエージェントは、サーバーにTCP セッションを接続します。
5.  プロジェクトアクセスキーに含まれる通信用秘密キーを使用してデータを暗号化し、新しいセッション用のセキュリティキーを要請します。
6.  サーバーは、エージェントが要求したセッション用のセキュリティキーを新しく作成し、エージェントにダウンロードします。
7.  セッション用のセキュリティキーは2つのパスワードキーを含んでいます。ASCアルゴリズム用の暗号キーとデフォルトの暗号キーです。
8.  その後、エージェントはテキストや制御などの重要なデータにはASC暗号キーを使用します。数値データのように比較的安全なデータは、単純な暗号化を経てデータをサーバーに転送します。
